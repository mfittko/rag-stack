{{- $devPassword := "devpassword" -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-postgres-secret
  labels:
    {{- include "rag.labels" . | nindent 4 }}
  {{- if not .Values.postgres.password }}
  annotations:
    # WARNING: Using default dev password - NOT SECURE for production
    helm.sh/resource-policy: "keep"
    security.warning: "Using insecure default password 'devpassword'. Override with --set postgres.password=<secure> for production."
  {{- end }}
type: Opaque
stringData:
  POSTGRES_USER: "{{ .Values.postgres.user }}"
  {{- if .Values.postgres.password }}
  POSTGRES_PASSWORD: "{{ .Values.postgres.password }}"
  {{- else }}
  # Dev-only default password (INSECURE - override in production with --set postgres.password=<secure>)
  POSTGRES_PASSWORD: "{{ $devPassword }}"
  {{- end }}
  # urlquery encodes special characters (@, :, /, #, etc.) for safe use in connection strings.
  # Note: Spaces are encoded as '+' (form encoding), which PostgreSQL clients accept.
  # For production, use passwords without spaces (e.g., randomly generated alphanumeric+symbols).
  {{- if .Values.postgres.password }}
  DATABASE_URL: "postgresql://{{ urlquery .Values.postgres.user }}:{{ urlquery .Values.postgres.password }}@{{ .Release.Name }}-postgres:{{ .Values.postgres.service.port }}/{{ urlquery .Values.postgres.database }}"
  {{- else }}
  DATABASE_URL: "postgresql://{{ .Values.postgres.user }}:{{ $devPassword }}@{{ .Release.Name }}-postgres:{{ .Values.postgres.service.port }}/{{ .Values.postgres.database }}"
  {{- end }}
